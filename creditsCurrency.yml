# ========================================
# Credits Currency / Economy
# Tyler J. Sawyer
# Simon Anguish
# Last Updated: 4/22/14
# ========================================
# 
# Credits Currency
# ----------------
#
# A custom Denizen-based economy scripting protocol that allows players to
# buy, sell, and trade items to NPCs designated as the 'vendor' assignment.
#
# Item buy/sell values can be customized in the appropriate NPC assignment 
# script. 
#
# NPCs can be customized to require a certain faction in order to speak to
# a particular player.
#
# NPCs may also be assigned the 'Auction' assignment to allow players to 
# sell unique or custom items obtained through the server (such as custom 
# boss loot) to other players for credits.
#
# Credits may be used to buy (almost) all items in the game.
#
# Players can also transfer credits to one another in trade for 
# specific items using the /credit transfer amt player command.
#
# See the individual commands below for comments and details.
# ========================================
#

"CreditsInitializer":
  type: world
  events:
    on player join:
    # Credit Check - See if a player has a credit flag.
    # If not, create one and set it equal to 0.
    - if <player.flag[CURRENCY_Credits]> == "null" {
      - flag player "CURRENCY_Credits:0" }
      
"CreditsCommands":
  type: world
  events:
    # Player Commands
    # credits command
    # Tells the player how many credits they have.
    # May also specify 'credits trade' to trade x credits to a player.
    # Usage:
    # /credits trade <amt> <playerName>
    on credits command:
    - if <context.args.get[1]> == null {
      - narrate "<yellow>You have <player.flag[CURRENCY_Credits]> credits in your wallet."
      }
    - if <context.args.get[1]> != null && <context.args.get[1]> != trade {
      - narrate "<red>Invalid Syntax for <gold>/credits trade<red> command."
      - narrate "<red>Usage<&co> <gold>/credits trade <green>Amount <white>PlayerName"
      - narrate "<red>Desc<&co> Gives the specified amount of credits to the specified player."
      - queue clear
      }
    - if <context.args.get[1]> == trade && <context.args.get[2]> == null {
      - narrate "<red>Invalid Syntax for <gold>/credits trade<red> command."
      - narrate "<red>Usage<&co> <gold>/credits trade <green>Amount <white>PlayerName"
      - narrate "<red>Desc<&co> Gives the specified amount of credits to the specified player."
      - queue clear
      }
    - if <context.args.get[1]> == trade && <context.args.get[2]> != null && <context.args.get[3]> == null {
      - narrate "<red>Invalid Syntax for <gold>/credits trade<red> command."
      - narrate "<red>Usage<&co> <gold>/credits trade <green>Amount <white>PlayerName"
      - narrate "<red>Desc<&co> Gives the specified amount of credits to the specified player."
      - queue clear
      }
    - if <context.args.get[1]> == trade && <context.args.get[2]> != null && <context.args.get[3]> != null {
      - if <context.args.get[3]> == <player.name> {
        - narrate "<red>You cannot trade credits to yourself!"
        - queue clear
        }
      - define creditAmt <context.args.get[2]>
      - define destcurrentAmt <p@<context.args.get[3]>.flag[CURRENCY_Credits]>
      - define destnewAmt <math.as_int:%destcurrentAmt%+%creditAmt%>
      - define srccurrentAmt <p@<player.name>.flag[CURRENCY_Credits]>
      - define srcnewAmt <math.as_int:%srccurrentAmt%-%creditAmt%>
      - flag <p@<context.args.get[3]>> "CURRENCY_Credits:%destnewAmt%"
      - flag <p@<player.name>> "CURRENCY_Credits:%srcnewAmt%"
      - narrate targets:<context.args.get[3]> "<yellow><player.name> has transferred <context.args.get[2]> credits to your wallet."
      - narrate "<yellow>You have transferred <context.args.get[2]> credits to <context.args.get[3]><&sq>s wallet."
      }
    # Admin Commands
    # CreditAdd command.
    # /creditadd <amt> <player>
    # Gives a <player> <amt> credits.
    on creditadd command:
    - if <player.name> != "Aayrl" && <player.name> != "Jennavb13" && <player.name> != "mtotho" {
      - narrate "<red>You may not use this command."
      - queue clear
      }
    - if <context.args.get[2]> == null || <context.args.get[1]> == null {
      - narrate "<red>Invalid Syntax for <gold>/creditadd<red> command."
      - narrate "<red>Usage<&co> <gold>/creditadd <green>Amount <white>PlayerName"
      - narrate "<red>Desc<&co> Adds specified amount of credits to a specified player<&sq>s wallet."
      - queue clear
      }
    - if <p@<context.args.get[2]>.is_online> == false {
      - narrate "<red><context.args.get[2]> is not online. Player must be online."
      - queue clear
      }
    - if <context.args.get[2]> != null {
      - define creditAmt <context.args.get[1]>
      - define currentAmt <p@<context.args.get[2]>.flag[CURRENCY_Credits]>
      - define newAmt <math.as_int:%currentAmt%+%creditAmt%>
      - flag <p@<context.args.get[2]>> "CURRENCY_Credits:%newAmt%"
      - narrate targets:<context.args.get[2]> "<yellow>Adding <context.args.get[1]> credits to your wallet."
      - narrate "<&7><&O>Giving <context.args.get[1]> credits to <context.args.get[2]>."
      }
    # Creditsub command.
    # /creditsub <amt> <player>
    # Takes <amt> credits from <player>.
    on creditsub command:
    - if <player.name> != "Aayrl" && <player.name> != "Jennavb13" && <player.name> != "mtotho" {
      - narrate "<red>You may not use this command."
      - queue clear
      }
    - if <context.args.get[2]> == null || <context.args.get[1]> == null {
      - narrate "<red>Invalid Syntax for <gold>/creditsub<red> command."
      - narrate "<red>Usage<&co> <gold>/creditsub <green>Amount <white>PlayerName"
      - narrate "<red>Desc<&co> Removes specified amount of credits from a specified player<&sq>s wallet."
      - queue clear
      }
    - if <p@<context.args.get[2]>.is_online> == false {
      - narrate "<red><context.args.get[2]> is not online. Player must be online."
      - queue clear
      }
    - if <context.args.get[2]> != null {
      - define creditAmt <context.args.get[1]>
      - define currentAmt <p@<context.args.get[2]>.flag[CURRENCY_Credits]>
      - define newAmt <math.as_int:%currentAmt%-%creditAmt%>
      - flag <p@<context.args.get[2]>> "CURRENCY_Credits:%newAmt%"
      - narrate targets:<context.args.get[2]> "<yellow>Removing <context.args.get[1]> credits from your wallet."
      - narrate "<&7><&O>Taking <context.args.get[1]> credits from <context.args.get[2]>."
      }
    # Creditset command.
    # /creditset <amt> <player>
    # Sets a <player> credit count to <amt>.
    on creditset command:
    - if <player.name> != "Aayrl" && <player.name> != "Jennavb13" && <player.name> != "mtotho" {
      - narrate "<red>You may not use this command."
      - queue clear
      }
    - if <context.args.get[2]> == null || <context.args.get[1]> == null {
      - narrate "<red>Invalid Syntax for <gold>/creditset<red> command."
      - narrate "<red>Usage<&co> <gold>/creditsset <green>Amount <white>PlayerName"
      - narrate "<red>Desc<&co> Sets a specified player<&sq>s wallet to the specified amount of credits."
      - queue clear
      }
    - if <p@<context.args.get[2]>.is_online> == false {
      - narrate "<red><context.args.get[2]> is not online. Player must be online."
      - queue clear
      }
    - if <context.args.get[2]> != null {
      - define creditAmt <context.args.get[1]>
      - flag <p@<context.args.get[2]>> "CURRENCY_Credits:%creditAmt%"
      - narrate targets:<context.args.get[2]> "<yellow>Setting your wallet to %creditAmt% credits."
      - narrate "<&7><&O>Setting <context.args.get[2]><&sq>s wallet to <context.args.get[1]> credits."
      }
      
# ============================================================================================
#

# Generic Vendor

# Inventory
inv_vendor_generic:
 
  type: inventory

  # Valid inventory types: BREWING, CHEST, DISPENSER, ENCHANTING, ENDER_CHEST, HOPPER, PLAYER, WORKBENCH
  inventory: CHEST

  # Note that titles only work for CHEST type inventories.
  title: <gold>Vendor
 
  # The size must be a multiple of 9. It is recommended not to go above 54.
  size: 27
 
  # You can specify the items in the slots of the inventory. For empty spaces, simply put
  # an empty "slot". Note the quotes around the entire lines.
  slots:
    - "[] [] [] [] [seeds] [] [wood] [] []"
    - "[] [] [] [] [] [] [stone] [] []"
    - "[i@Rusty_Scimitar] [] [] [] [] [] [] [] []"

# Assignment
"vendor_generic":
    type: assignment
    
    interact scripts:
    - 10 vendorGenericScript
    
    actions:
      on spawn:
      - trigger name:proximity toggle:true radius:4
      - inventory swap d:<n@<npc.id>.inventory> o:<in@inv_vendor_generic>
      
      on enter proximity:
      - narrate "<white><npc.name> says<&cm> <&sq>Hey there<&cm> <player.name>!<&sq>"
      - inventory swap d:<n@<npc.id>.inventory> o:<in@inv_vendor_generic>

'vendorGenericScript':
    type: interact
    
    steps:
      1:
        click trigger:
          script:
            # Right Clicking on the vendor appraises the item in the player's hand.
            - narrate "<white><npc.name> says<&cm> <&sq>Welcome to my shop<&cm> <player.name>.<&sq>"
            - inventory open d:<n@<npc.id>.inventory>

"vendorInventoryEvents":
  type: world
  events:
    # Tell the player how to use a merchant.
    on vendorhelp command:
    - narrate "<yellow>Coming Soon!"
    # When a player left clicks on an item, give price information about it.
    on player left clicks in inventory:
    - if <context.inventory.id_holder> == n@109 {
      - narrate "<yellow>That<&sq>ll be CREDIT_AMT credits for the <context.item.display_name>."
      - determine CANCELLED
      }
    on player right clicks in inventory:
    - if <context.inventory.id_holder> == n@109 {
      - narrate "<yellow>You receive CREDIT_AMT credits for your <context.item.display_name>."
      - determine CANCELLED
      }
    